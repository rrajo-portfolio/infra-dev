services:
  mysql-catalog:
    image: mysql:8.0
    container_name: ${CONTAINER_PREFIX:-}mysql_catalog
    deploy:
      resources:
        reservations:
          memory: "${MYSQL_CATALOG_MEM:-512m}"
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: catalogdb
      MYSQL_USER: catalog_user
      MYSQL_PASSWORD: catalog_pass
    ports:
      - "${CATALOG_DB_PORT:-3307}:3306"
    volumes:
      - catalog-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mysql-users:
    image: mysql:8.0
    container_name: ${CONTAINER_PREFIX:-}mysql_users
    deploy:
      resources:
        reservations:
          memory: "${MYSQL_USERS_MEM:-512m}"
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usersdb
      MYSQL_USER: users_user
      MYSQL_PASSWORD: users_pass
    ports:
      - "${USERS_DB_PORT:-3308}:3306"
    volumes:
      - users-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mysql-orders:
    image: mysql:8.0
    container_name: ${CONTAINER_PREFIX:-}mysql_orders
    deploy:
      resources:
        reservations:
          memory: "${MYSQL_ORDERS_MEM:-512m}"
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ordersdb
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
    ports:
      - "${ORDERS_DB_PORT:-3309}:3306"
    volumes:
      - orders-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mailhog:
    image: mailhog/mailhog:latest
    container_name: ${CONTAINER_PREFIX:-}mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_HTTP_PORT:-8025}:8025"
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
    networks:
      - portfolio-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: ${CONTAINER_PREFIX:-}elasticsearch
    deploy:
      resources:
        reservations:
          memory: "${ELASTICSEARCH_MEM:-1g}"
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "${ELASTIC_HTTP_PORT:-9200}:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - portfolio-net

  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.4
    container_name: ${CONTAINER_PREFIX:-}kibana
    restart: unless-stopped
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "${KIBANA_HTTP_PORT:-5601}:5601"
    depends_on:
      - elasticsearch
    networks:
      - portfolio-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: ${CONTAINER_PREFIX:-}zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "${ZOOKEEPER_PORT:-2181}:2181"
    networks:
      - portfolio-net

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: ${CONTAINER_PREFIX:-}kafka
    deploy:
      resources:
        reservations:
          memory: "${KAFKA_MEM:-768m}"
    restart: unless-stopped
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    ports:
      - "${KAFKA_PORT:-9094}:9094"
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - portfolio-net
    depends_on:
      - zookeeper

  keycloak-db:
    image: postgres:15
    container_name: ${CONTAINER_PREFIX:-}keycloak_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    networks:
      - portfolio-net

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: ${CONTAINER_PREFIX:-}keycloak
    deploy:
      resources:
        reservations:
          memory: "${KEYCLOAK_MEM:-512m}"
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KEYCLOAK_IMPORT: /opt/keycloak/data/import/portfolio-realm.json
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_PORT: ${KEYCLOAK_HTTP_PORT:-7080}
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_SPI_THEME_DEFAULT: portfolio-theme
      KC_SPI_THEME_CACHE_THEMES: "false"
      KC_SPI_THEME_CACHE_TEMPLATES: "false"
    command: ["start-dev", "--http-relative-path=/auth"]
    ports:
      - "${KEYCLOAK_HTTP_PORT:-7080}:8080"
    depends_on:
      - keycloak-db
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/auth/realms/master >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
    networks:
      - portfolio-net
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import
      - ./keycloak/themes/portfolio-theme:/opt/keycloak/themes/portfolio-theme:ro

  catalog-service:
    build:
      context: ${SERVICES_ROOT:-..}/catalog-service
    container_name: ${CONTAINER_PREFIX:-}catalog_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql-catalog:3306/catalogdb?useUnicode=true&characterEncoding=UTF-8&connectionCollation=utf8mb4_unicode_ci&serverTimezone=UTC&allowPublicKeyRetrieval=true&useSSL=false"
      SPRING_DATASOURCE_USERNAME: catalog_user
      SPRING_DATASOURCE_PASSWORD: catalog_pass
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
      SERVICES_USERS_BASE_URL: http://users-service:8082/api
      SECURITY_OAUTH2_JWK_SET_URI: http://keycloak:8080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      CATALOG_EVENTS_TOPIC: catalog-product-events
    depends_on:
      - mysql-catalog
      - elasticsearch
      - mailhog
      - kafka
    networks:
      - portfolio-net

  users-service:
    build:
      context: ${SERVICES_ROOT:-..}/users-service
    container_name: ${CONTAINER_PREFIX:-}users_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql-users:3306/usersdb?useUnicode=true&characterEncoding=UTF-8&connectionCollation=utf8mb4_unicode_ci&serverTimezone=UTC&allowPublicKeyRetrieval=true&useSSL=false"
      SPRING_DATASOURCE_USERNAME: users_user
      SPRING_DATASOURCE_PASSWORD: users_pass
      SECURITY_OAUTH2_JWK_SET_URI: http://keycloak:8080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
    depends_on:
      - mysql-users
    networks:
      - portfolio-net

  orders-service:
    build:
      context: ${SERVICES_ROOT:-..}/orders-service
    container_name: ${CONTAINER_PREFIX:-}orders_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql-orders:3306/ordersdb?useUnicode=true&characterEncoding=UTF-8&connectionCollation=utf8mb4_unicode_ci&serverTimezone=UTC&allowPublicKeyRetrieval=true&useSSL=false"
      SPRING_DATASOURCE_USERNAME: orders_user
      SPRING_DATASOURCE_PASSWORD: orders_pass
      SERVICES_USERS_BASE_URL: http://users-service:8082/api
      SERVICES_CATALOG_BASE_URL: http://catalog-service:8081/api
      SECURITY_OAUTH2_JWK_SET_URI: http://keycloak:8080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: rabbit
      SPRING_RABBITMQ_PASSWORD: rabbit
      ORDERS_NOTIFICATION_ENABLED: "true"
      SERVICE_ACCOUNT_USERNAME: portfolio-admin
      SERVICE_ACCOUNT_PASSWORD: admin123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      ORDERS_KAFKA_TOPIC: orders-checkout-events
    depends_on:
      - mysql-orders
      - catalog-service
      - users-service
    networks:
      - portfolio-net

  nginx:
    build:
      context: ${NGINX_BUILD_CONTEXT:-./nginx}
    image: ${NGINX_IMAGE:-portfolio-nginx}
    container_name: ${CONTAINER_PREFIX:-}api_gateway
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-8080}:80"
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net
  gateway-service:
    build:
      context: ${SERVICES_ROOT:-..}/gateway-service
    container_name: ${CONTAINER_PREFIX:-}gateway_service
    restart: unless-stopped
    environment:
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://keycloak:8080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      GATEWAY_KEYCLOAK_INTERNAL_ISSUER: http://keycloak:8080/auth/realms/portfolio
      GATEWAY_CATALOG_URI: http://catalog-service:8081
      GATEWAY_USERS_URI: http://users-service:8082
      GATEWAY_ORDERS_URI: http://orders-service:8084
    ports:
      - "${GATEWAY_HTTP_PORT:-8085}:8080"
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net

  notification-service:
    build:
      context: ${SERVICES_ROOT:-..}/notification-service
    container_name: ${CONTAINER_PREFIX:-}notification_service
    restart: unless-stopped
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: rabbit
      SPRING_RABBITMQ_PASSWORD: rabbit
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
    depends_on:
      - rabbitmq
      - mailhog
    ports:
      - "${NOTIFICATION_HTTP_PORT:-8086}:8080"
    networks:
      - portfolio-net

  frontend-service:
    build:
      context: ${SERVICES_ROOT:-..}/frontend-service
    container_name: ${CONTAINER_PREFIX:-}frontend_service
    restart: unless-stopped
    environment:
      API_URL: ${FRONTEND_API_URL:-http://localhost:${GATEWAY_HTTP_PORT:-8085}}
      KEYCLOAK_URL: ${FRONTEND_KEYCLOAK_URL:-http://localhost:${KEYCLOAK_HTTP_PORT:-7080}/auth}
      KEYCLOAK_REALM: portfolio
      KEYCLOAK_CLIENT_ID: portfolio-frontend
    ports:
      - "${FRONTEND_HTTP_PORT:-8087}:80"
    depends_on:
      - gateway-service
      - keycloak
    networks:
      - portfolio-net

  sonarqube:
    image: sonarqube:lts-community
    container_name: ${CONTAINER_PREFIX:-}sonarqube
    deploy:
      resources:
        reservations:
          memory: "${SONARQUBE_MEM:-1g}"
    restart: unless-stopped
    environment:
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      SONARQUBE_JAVAOPTS: "-Xms1g -Xmx2g"
    ports:
      - "${SONAR_HTTP_PORT:-9000}:9000"
    volumes:
      - sonarqube-data:/opt/sonarqube/data
      - sonarqube-logs:/opt/sonarqube/logs
      - sonarqube-extensions:/opt/sonarqube/extensions
    networks:
      - portfolio-net

  prometheus:
    image: prom/prometheus:v2.55.0
    container_name: ${CONTAINER_PREFIX:-}prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "${PROMETHEUS_HTTP_PORT:-9090}:9090"
    depends_on:
      - catalog-service
      - users-service
      - orders-service
      - gateway-service
      - notification-service
    networks:
      - portfolio-net

  grafana:
    image: grafana/grafana:11.1.0
    container_name: ${CONTAINER_PREFIX:-}grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    ports:
      - "${GRAFANA_HTTP_PORT:-3000}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - portfolio-net

  jenkins:
    build:
      context: ./jenkins
    container_name: ${CONTAINER_PREFIX:-}jenkins
    user: root
    restart: unless-stopped
    environment:
      JAVA_OPTS: "-Dorg.apache.commons.jelly.tags.fmt.timeZone=UTC"
    ports:
      - "${JENKINS_HTTP_PORT:-8090}:8080"
      - "${JENKINS_AGENT_PORT:-50000}:50000"
    volumes:
      - ${SERVICES_ROOT:-..}/jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net

  adminer:
    image: adminer:latest
    container_name: ${CONTAINER_PREFIX:-}adminer
    restart: unless-stopped
    ports:
      - "${ADMINER_HTTP_PORT:-8088}:8080"
    networks:
      - portfolio-net

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: ${CONTAINER_PREFIX:-}rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: rabbit
      RABBITMQ_DEFAULT_PASS: rabbit
    ports:
      - "${RABBITMQ_AMQP_PORT:-5672}:5672"
      - "${RABBITMQ_HTTP_PORT:-15672}:15672"
    networks:
      - portfolio-net

volumes:
  catalog-mysql:
    name: ${VOLUME_NAMESPACE:-infra-dev}_catalog-mysql
  users-mysql:
    name: ${VOLUME_NAMESPACE:-infra-dev}_users-mysql
  orders-mysql:
    name: ${VOLUME_NAMESPACE:-infra-dev}_orders-mysql
  keycloak-db:
    name: ${VOLUME_NAMESPACE:-infra-dev}_keycloak-db
  elasticsearch-data:
    name: ${VOLUME_NAMESPACE:-infra-dev}_elasticsearch-data
  kafka-data:
    name: ${VOLUME_NAMESPACE:-infra-dev}_kafka-data
  sonarqube-data:
    name: ${VOLUME_NAMESPACE:-infra-dev}_sonarqube-data
  sonarqube-logs:
    name: ${VOLUME_NAMESPACE:-infra-dev}_sonarqube-logs
  sonarqube-extensions:
    name: ${VOLUME_NAMESPACE:-infra-dev}_sonarqube-extensions
  prometheus-data:
    name: ${VOLUME_NAMESPACE:-infra-dev}_prometheus-data
  grafana-data:
    name: ${VOLUME_NAMESPACE:-infra-dev}_grafana-data

networks:
  portfolio-net:
    driver: bridge
