version: "3.9"

services:
  mysql-catalog:
    image: mysql:8.0
    container_name: mysql_catalog
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: catalogdb
      MYSQL_USER: catalog_user
      MYSQL_PASSWORD: catalog_pass
    ports:
      - "3307:3306"
    volumes:
      - catalog-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mysql-users:
    image: mysql:8.0
    container_name: mysql_users
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usersdb
      MYSQL_USER: users_user
      MYSQL_PASSWORD: users_pass
    ports:
      - "3308:3306"
    volumes:
      - users-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mysql-orders:
    image: mysql:8.0
    container_name: mysql_orders
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ordersdb
      MYSQL_USER: orders_user
      MYSQL_PASSWORD: orders_pass
    ports:
      - "3309:3306"
    volumes:
      - orders-mysql:/var/lib/mysql
    networks:
      - portfolio-net

  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    restart: unless-stopped
    ports:
      - "8025:8025"
      - "1025:1025"
    networks:
      - portfolio-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - portfolio-net

  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.4
    container_name: kibana
    restart: unless-stopped
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - portfolio-net

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - portfolio-net

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: kafka
    restart: unless-stopped
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    ports:
      - "9094:9094"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - portfolio-net
    depends_on:
      - zookeeper

  keycloak-db:
    image: postgres:15
    container_name: keycloak_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - keycloak-db:/var/lib/postgresql/data
    networks:
      - portfolio-net

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: ["start-dev", "--http-relative-path=/auth"]
    ports:
      - "7080:8080"
    depends_on:
      - keycloak-db
    networks:
      - portfolio-net

  catalog-service:
    build:
      context: ${SERVICES_ROOT:-..}/catalog-service
    container_name: catalog_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-catalog:3306/catalogdb
      SPRING_DATASOURCE_USERNAME: catalog_user
      SPRING_DATASOURCE_PASSWORD: catalog_pass
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SERVICES_USERS_BASE_URL: http://users-service:8082/api
      SECURITY_OAUTH2_JWK_SET_URI: http://host.docker.internal:7080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      CATALOG_EVENTS_TOPIC: catalog-product-events
    depends_on:
      - mysql-catalog
      - elasticsearch
      - mailhog
      - kafka
    networks:
      - portfolio-net

  users-service:
    build:
      context: ${SERVICES_ROOT:-..}/users-service
    container_name: users_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-users:3306/usersdb
      SPRING_DATASOURCE_USERNAME: users_user
      SPRING_DATASOURCE_PASSWORD: users_pass
      SECURITY_OAUTH2_JWK_SET_URI: http://host.docker.internal:7080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
    depends_on:
      - mysql-users
    networks:
      - portfolio-net

  orders-service:
    build:
      context: ${SERVICES_ROOT:-..}/orders-service
    container_name: orders_service
    restart: unless-stopped
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-orders:3306/ordersdb
      SPRING_DATASOURCE_USERNAME: orders_user
      SPRING_DATASOURCE_PASSWORD: orders_pass
      SERVICES_USERS_BASE_URL: http://users-service:8082/api
      SERVICES_CATALOG_BASE_URL: http://catalog-service:8081/api
      SECURITY_OAUTH2_JWK_SET_URI: http://host.docker.internal:7080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: rabbit
      SPRING_RABBITMQ_PASSWORD: rabbit
      ORDERS_NOTIFICATION_ENABLED: "true"
    depends_on:
      - mysql-orders
      - catalog-service
      - users-service
    networks:
      - portfolio-net

  nginx:
    image: nginx:alpine
    container_name: api_gateway
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net
  gateway-service:
    build:
      context: ${SERVICES_ROOT:-..}/gateway-service
    container_name: gateway_service
    restart: unless-stopped
    environment:
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://host.docker.internal:7080/auth/realms/portfolio/protocol/openid-connect/certs
      SECURITY_OAUTH2_EXPECTED_ISSUER: http://localhost:7080/auth/realms/portfolio
      GATEWAY_CATALOG_URI: http://catalog-service:8081
      GATEWAY_USERS_URI: http://users-service:8082
      GATEWAY_ORDERS_URI: http://orders-service:8084
    ports:
      - "8085:8080"
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net

  notification-service:
    build:
      context: ${SERVICES_ROOT:-..}/notification-service
    container_name: notification_service
    restart: unless-stopped
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: rabbit
      SPRING_RABBITMQ_PASSWORD: rabbit
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
    depends_on:
      - rabbitmq
      - mailhog
    networks:
      - portfolio-net

  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    restart: unless-stopped
    environment:
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
      SONARQUBE_JAVAOPTS: "-Xms1g -Xmx2g"
    ports:
      - "9000:9000"
    volumes:
      - sonarqube-data:/opt/sonarqube/data
      - sonarqube-logs:/opt/sonarqube/logs
      - sonarqube-extensions:/opt/sonarqube/extensions
    networks:
      - portfolio-net

  jenkins:
    build:
      context: ./jenkins
    container_name: jenkins
    user: root
    restart: unless-stopped
    environment:
      JAVA_OPTS: "-Dorg.apache.commons.jelly.tags.fmt.timeZone=UTC"
    ports:
      - "8090:8080"
      - "50000:50000"
    volumes:
      - ${SERVICES_ROOT:-..}/jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - catalog-service
      - users-service
      - orders-service
    networks:
      - portfolio-net

  adminer:
    image: adminer:latest
    container_name: adminer
    restart: unless-stopped
    ports:
      - "8088:8080"
    networks:
      - portfolio-net

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: rabbit
      RABBITMQ_DEFAULT_PASS: rabbit
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - portfolio-net

volumes:
  catalog-mysql:
  users-mysql:
  orders-mysql:
  keycloak-db:
  elasticsearch-data:
  kafka-data:
  sonarqube-data:
  sonarqube-logs:
  sonarqube-extensions:

networks:
  portfolio-net:
    driver: bridge
